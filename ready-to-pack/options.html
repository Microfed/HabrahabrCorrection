<!DOCTYPE html>
<html>
<head><title>Настроки расширения HabraCorrection</title></head>
<link href="/css/skin-vista/ui.dynatree.css" rel="stylesheet" type="text/css">
<link href="/css/redmond/jquery-ui-1.8.16.custom.css" rel="stylesheet" type="text/css">
<script type="text/javascript" src="/js/jquery-1.6.2.min.js"></script>
<script type="text/javascript" src="/js/jquery.cookie.js"></script>
<script type="text/javascript" src="/js/jquery-ui-1.8.16.custom.min.js"></script>
<script type="text/javascript" src="/js/jquery.dynatree.min.js"></script>

<script type="text/javascript">
    function save_options() {
        var isAdvtAttachToMessage = document.getElementById('isAdvtAttachToMessage').checked

        localStorage["isAdvtAttachToMessage"] = isAdvtAttachToMessage;

        var dict = $("#errorTree").dynatree("getTree").toDict();
        localStorage["errorList"] = JSON.stringify(dict.children);

        printStatusMessage("Сохранено");
    }

    function printStatusMessage(messageText) {
        $('#status').append(messageText);
        $('#status').show();
        setTimeout(function() {
            $('#status').effect('fade', 500, function() {
                $('#status').empty();
            });
        }, 2000);
    }

    function setErrorListFromFile() {
        $.getJSON(chrome.extension.getURL('/errorList.json'), function(data) {
            localStorage["errorList"] = JSON.stringify(data);
        });

        setTreeInfo();
        printStatusMessage("Список ошибок загружен");
    }

    function addButtonsToManageTree() {
        $('button', '#activeTreeElement').button();

        $('#delete', '#activeTreeElement').click(function() {
            $('#errorTree').dynatree("getActiveNode").remove();

            //Fix error: плагин после удаления элемента срет в стиль этого дива (display: none)
            $('#activeTreeElement').show();
        });

        $('#accept', '#activeTreeElement').click(function() {
            var node = $("#errorTree").dynatree("getActiveNode");
            if (!node) return;
            var title = $('#activeTreeElement #title').val();
            var messageText = $('#activeTreeElement #messageText').val();
            var isFolder = $('#activeTreeElement #isFolder').val();
            node.fromDict({
                title: title,
                messageText: messageText,
                isFolder: isFolder});
        });

        $('#add', '#activeTreeElement').click(function() {
            var parentNode;
            var root = $("#errorTree").dynatree("getRoot");
            var activeNode = $("#errorTree").dynatree("getActiveNode");

            if (activeNode !== null) {
                if (activeNode.data.isFolder) {
                    parentNode = activeNode;
                } else {
                    parentNode = activeNode.getParent();
                }
            } else {
                parentNode = root;
                activeNode = root;
            }

            var title = $('#activeTreeElement #title').val();
            var messageText = $('#activeTreeElement #messageText').val();

            var isFolder = false;

            if (parentNode === root && !(activeNode.data.isFolder)) {
                isFolder = ($('#activeTreeElement #isFolder:checked').val() !== undefined);
            }

            parentNode.addChild({
                title: title,
                messageText: messageText,
                isFolder: isFolder
            });

        });

    }

    function setTreeInfo() {
        var treeDiv = $("#errorTree");
        
        if (treeDiv.text() !== '') {
            treeDiv.dynatree("getTree").reload();
        } else {
            treeDiv.dynatree({
                onActivate: function(node) {
                    printNodeInfo(node);
                },
                onDeactivate: function(node) {
                    clearNodeInfo();
                },
                children: JSON.parse(localStorage["errorList"])
            });

            addButtonsToManageTree();
        }
    }

    function restore_options() {
        var isAdvtAttachToMessage = localStorage["isAdvtAttachToMessage"];
        var result = false;

        if (isAdvtAttachToMessage == 'true') {
            result = true;
        }
        document.getElementById('isAdvtAttachToMessage').checked = result;

        if (localStorage["errorList"] === undefined) {
            setErrorListFromFile();
        }

        setTreeInfo();
    }

    function printNodeInfo(node) {
        $('#activeTreeElement #title').val(node.data.title);
        $('#activeTreeElement #messageText').val(node.data.messageText);
        if (node.data.isFolder) {
            $('#activeTreeElement #isFolder').attr("checked", "checked");
        }
        $('#activeTreeElement').show();
    }

    function clearNodeInfo() {
        $("#activeTreeElement #title").empty();
        $("#activeTreeElement #messageText").empty();
        $('#activeTreeElement #isFolder').removeAttr("checked");
        $('#activeTreeElement').hide();
    }
</script>
<body onload="restore_options()">
<h3>Настроки расширения HabraCorrection</h3>
<h4>Формирование сообщения об ошибке</h4>
<input type="checkbox" id="isAdvtAttachToMessage"/> Добавлять информацию о расширении в конец </br>
сообщения об ошибке ("<sub>Сделано с помощью <a
        href="https://chrome.google.com/webstore/detail/kcdmenmdkfpfbdilcpfehcnahhkjfipe">HabraCorrection</a>.</sub>")
<br/><br/>
<h4>Редактирование списка ошибок</h4>

<div id="activeTreeElement" style="border: 1px dotted gray; width: 620px;font-family:verdana,sans-serif;font-size:12px">
    <small>Не больше 2-х уровней вложенности относительно корня</small>
    <div id="errorTree" style="width: 618px"></div>
    <strong>Название ошибки/раздела: </strong></strong><br/>
    <input type="text" id="title" style="width: 510px">
    <input type="checkbox" id="isFolder"> это раздел<br/>
    <strong>Текст сообщения об ошибке:</strong><br/>
    <textarea id="messageText" cols="74" rows="4" maxlength="500"></textarea>
    <br/>
    <button id="accept">Принять изменения</button>
    <button id="delete">Удалить ошибку</button>
    <button id="add">Добавить ошибку</button>
</div>
<br/><br/>
<button onclick="save_options()">Сохранить все настройки</button>
<button onclick="setErrorListFromFile()">Восстановить список ошибок по умолчанию</button>
<div id="status" class="ui-widget-content" hidden></div>
</body>
</html>